<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Pro Cam Web</title>
    <style>
        body { margin: 0; background: #000; font-family: sans-serif; color: white; overflow: hidden; }
        #video { width: 100vw; height: 100vh; object-fit: cover; }
        
        /* Controles superiores (Zoom y Lente) */
        .top-bar { position: absolute; top: 10px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; background: rgba(0,0,0,0.4); padding: 10px 0; }
        .slider-container { width: 80%; display: flex; align-items: center; gap: 10px; }
        input[type=range] { flex-grow: 1; }

        /* Controles inferiores (Disparo y Flash) */
        .bottom-bar { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-around; align-items: center; }
        
        .btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 15px; border-radius: 10px; font-size: 14px; }
        #btn-capture { width: 80px; height: 80px; background: white; border-radius: 50%; border: 5px solid rgba(0,0,0,0.2); }
        #btn-capture:active { transform: scale(0.9); }
    </style>
</head>
<body>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <div class="top-bar">
        <div class="slider-container">
            <span>Zoom</span>
            <input type="range" id="zoom-slider" min="1" max="10" step="0.1" value="1">
        </div>
        <div id="lens-info" style="font-size: 12px; opacity: 0.7;">Detectando lentes...</div>
    </div>

    <div class="bottom-bar">
        <button class="btn" id="btn-flash">ðŸ”¦ Flash Off</button>
        <button id="btn-capture"></button>
        <button class="btn" id="btn-switch">ðŸ”„ Cambiar Lente</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const zoomSlider = document.getElementById('zoom-slider');
        const btnFlash = document.getElementById('btn-flash');
        const btnSwitch = document.getElementById('btn-switch');
        const lensInfo = document.getElementById('lens-info');
        
        let currentStream;
        let track;
        let devices = [];
        let currentDeviceIndex = 0;
        let flashOn = false;

        // 1. Buscar todos los lentes disponibles
        async function getLenses() {
            const allDevices = await navigator.mediaDevices.enumerateDevices();
            devices = allDevices.filter(d => d.kind === 'videoinput');
            lensInfo.innerText = `Lentes encontrados: ${devices.length}`;
        }

        // 2. Iniciar cÃ¡mara con controles
        async function startCamera(deviceId) {
            if (currentStream) {
                currentStream.getTracks().forEach(t => t.stop());
            }

            const constraints = {
                video: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    width: { ideal: 4096 },
                    height: { ideal: 2160 }
                }
            };

            try {
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                track = currentStream.getVideoTracks()[0];
                
                // Configurar capacidades (Zoom y Flash)
                const capabilities = track.getCapabilities();
                if (capabilities.zoom) {
                    zoomSlider.min = capabilities.zoom.min;
                    zoomSlider.max = capabilities.zoom.max;
                    zoomSlider.step = capabilities.zoom.step;
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Evento: Zoom
        zoomSlider.addEventListener('input', () => {
            if (track) {
                track.applyConstraints({ advanced: [{ zoom: zoomSlider.value }] });
            }
        });

        // Evento: Flash (Antorcha)
        btnFlash.addEventListener('click', async () => {
            if (track) {
                flashOn = !flashOn;
                try {
                    await track.applyConstraints({ advanced: [{ torch: flashOn }] });
                    btnFlash.innerText = flashOn ? "ðŸ”¦ Flash ON" : "ðŸ”¦ Flash OFF";
                } catch (e) {
                    alert("Este lente no soporta Flash");
                }
            }
        });

        // Evento: Cambiar Lente (Ciclo entre todos los sensores)
        btnSwitch.addEventListener('click', () => {
            currentDeviceIndex = (currentDeviceIndex + 1) % devices.length;
            startCamera(devices[currentDeviceIndex].deviceId);
        });

        // Evento: Capturar
        document.getElementById('btn-capture').addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const link = document.createElement('a');
            link.download = `Pixel_Pro_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        });

        // Inicio
        getLenses().then(() => startCamera());
    </script>
</body>
</html>