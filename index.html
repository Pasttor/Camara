<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Unified Cam</title>
    <style>
        /* Estilos generales para pantalla completa */
        body { margin: 0; background: #000; font-family: sans-serif; color: white; overflow: hidden; height: 100vh; width: 100vw; }
        #video-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; opacity: 0.6; /* Un poco transparente para destacar los controles */ }
        
        /* --- BARRA SUPERIOR (Controles WebApp) --- */
        .top-bar { position: absolute; top: 0; width: 100%; background: rgba(0,0,0,0.5); padding: 15px 0; display: flex; flex-direction: column; align-items: center; }
        .slider-container { width: 85%; display: flex; align-items: center; gap: 15px; font-weight: bold; }
        input[type=range] { flex-grow: 1; height: 5px; }
        #lens-info { font-size: 11px; margin-top: 5px; opacity: 0.8; }

        /* --- BARRA INFERIOR (Controles Nativos) --- */
        .bottom-bar-unified {
            position: absolute; bottom: 0; width: 100%; height: 120px;
            display: flex; justify-content: space-evenly; align-items: center;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding-bottom: 20px;
        }

        /* Estilo de los botones laterales */
        .side-btn {
            width: 60px; height: 60px; border-radius: 50%;
            background: rgba(255,255,255,0.15); color: white; border: none;
            font-size: 24px; display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .side-btn span { font-size: 12px; display: block; margin-top: 2px; }

        /* Bot贸n Central de FOTO (Estilo Google) */
        #btn-native-photo {
            width: 85px; height: 85px;
            background: white; border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #btn-native-photo:active { transform: scale(0.95); background: #eee; }
    </style>
</head>
<body>

    <video id="video-background" autoplay playsinline muted></video>
    
    <div class="top-bar">
        <div class="slider-container">
            <span> Zoom Web</span>
            <input type="range" id="zoom-slider" min="1" max="10" step="0.1" value="1">
        </div>
        <div id="lens-info">Cargando lentes del Pixel...</div>
    </div>

    <div class="bottom-bar-unified">
        
        <button class="side-btn" id="trigger-video">
            <div><br><span>Video Pro</span></div>
        </button>

        <button id="trigger-photo"></button>

        <button class="side-btn" id="btn-switch-web">
            <div><br><span>Visor Web</span></div>
        </button>
    </div>

    <input type="file" id="native-photo-input" accept="image/*" capture="environment" style="display:none;">
    <input type="file" id="native-video-input" accept="video/*" capture="environment" style="display:none;">


    <script>
        // =========================================
        // PARTE 1: L贸gica de los Controles Nativos
        // =========================================
        const triggerPhoto = document.getElementById('trigger-photo');
        const triggerVideo = document.getElementById('trigger-video');
        const nativePhotoInput = document.getElementById('native-photo-input');
        const nativeVideoInput = document.getElementById('native-video-input');

        // Conectar los botones visibles a los inputs ocultos
        triggerPhoto.addEventListener('click', () => nativePhotoInput.click());
        triggerVideo.addEventListener('click', () => nativeVideoInput.click());

        // Funci贸n gen茅rica para manejar el archivo que regresa la app nativa
        function handleNativeCapture(inputElement, prefix, ext) {
            if (inputElement.files && inputElement.files[0]) {
                const file = inputElement.files[0];
                const url = URL.createObjectURL(file);
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                link.href = url;
                link.download = `Pixel7Pro_${prefix}_${timestamp}.${ext}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // Limpiar memoria
                // Opcional: Vibrar para confirmar
                if (navigator.vibrate) navigator.vibrate(200);
            }
        }

        // Escuchar cuando regresan los archivos
        nativePhotoInput.addEventListener('change', (e) => handleNativeCapture(e.target, 'FOTO_PRO', 'jpg'));
        nativeVideoInput.addEventListener('change', (e) => handleNativeCapture(e.target, 'VIDEO_PRO', 'mp4'));


        // =========================================
        // PARTE 2: L贸gica del Visor Web de Fondo (V2.0)
        // =========================================
        const videoBg = document.getElementById('video-background');
        const zoomSlider = document.getElementById('zoom-slider');
        const btnSwitchWeb = document.getElementById('btn-switch-web');
        const lensInfo = document.getElementById('lens-info');
        
        let currentStream;
        let videoTrack;
        let devices = [];
        let currentDeviceIndex = 0;

        async function getLenses() {
            try {
                const allDevices = await navigator.mediaDevices.enumerateDevices();
                devices = allDevices.filter(d => d.kind === 'videoinput');
                // Intentar filtrar para dejar solo los traseros principales si hay muchos
                const backLenses = devices.filter(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('environment'));
                if (backLenses.length > 1) devices = backLenses;
                lensInfo.innerText = `Sensores disponibles para visor web: ${devices.length}`;
            } catch(e) { lensInfo.innerText = "Error detectando lentes"; }
        }

        async function startWebCamera(deviceId) {
            if (currentStream) currentStream.getTracks().forEach(t => t.stop());
            const constraints = { video: { deviceId: deviceId ? { exact: deviceId } : undefined, facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }};
            try {
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoBg.srcObject = currentStream;
                videoTrack = currentStream.getVideoTracks()[0];
                const cap = videoTrack.getCapabilities();
                if (cap.zoom) {
                    zoomSlider.min = cap.zoom.min; zoomSlider.max = cap.zoom.max; zoomSlider.step = cap.zoom.step || 0.1; zoomSlider.disabled = false;
                } else { zoomSlider.disabled = true; }
            } catch (e) { console.error(e); }
        }

        zoomSlider.addEventListener('input', () => {
            if (videoTrack) videoTrack.applyConstraints({ advanced: [{ zoom: parseFloat(zoomSlider.value) }] });
        });

        btnSwitchWeb.addEventListener('click', () => {
            if (devices.length > 0) {
                currentDeviceIndex = (currentDeviceIndex + 1) % devices.length;
                startWebCamera(devices[currentDeviceIndex].deviceId);
                // Vibraci贸n corta al cambiar lente web
                if (navigator.vibrate) navigator.vibrate(50);
            }
        });

        // Iniciar visor de fondo
        getLenses().then(() => startWebCamera());
    </script>
</body>
</html>